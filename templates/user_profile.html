{% extends "layout.html" %}

{% block title %}{{ user.username }}'s Profile - The Spreadsheet{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ user.username }}'s Profile</h1>
    {% if is_own_profile %}
    <p class="text-muted">This is your profile. <a href="{{ url_for('dashboard') }}">Go to your dashboard</a></p>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Bets</div>
            <div class="stat-value">{{ stats.totalBets }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Win Rate</div>
            <div class="stat-value">{{ "%.1f"|format(stats.winRate) }}%</div>
            <div class="stat-detail">{{ stats.wonBets }}W - {{ stats.lostBets }}L</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Profit</div>
            <div class="stat-value {% if stats.totalProfit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                {{ "%+.2f"|format(stats.totalProfit) }} units
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-label">ROI</div>
            <div class="stat-value {% if stats.roi >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                {{ "%.1f"|format(stats.roi) }}%
            </div>
        </div>
    </div>

    <!-- Analytics -->
    {% if analytics.betTypeStats %}
    <div class="card" style="margin-top: 30px;">
        <h2>Performance by Bet Type</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Bet Type</th>
                        <th>Bets</th>
                        <th>Win Rate</th>
                        <th>Profit</th>
                        <th>ROI</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in analytics.betTypeStats %}
                    <tr>
                        <td><strong>{{ stat.betType }}</strong></td>
                        <td>{{ stat.totalBets }} ({{ stat.wonBets }}W - {{ stat.lostBets }}L)</td>
                        <td>{{ "%.1f"|format(stat.winRate) }}%</td>
                        <td class="{% if stat.totalProfit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            {{ "%+.2f"|format(stat.totalProfit) }} units
                        </td>
                        <td class="{% if stat.roi >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            {{ "%.1f"|format(stat.roi) }}%
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Team Stats -->
    {% if analytics.teamStats %}
    <div class="card" style="margin-top: 30px;">
        <h2>Top Teams by Profit</h2>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Team</th>
                        <th>Record</th>
                        <th>Win Rate</th>
                        <th>Profit</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in analytics.teamStats %}
                    <tr>
                        <td><strong>{{ stat.team }}</strong></td>
                        <td>{{ stat.wins }}W - {{ stat.losses }}L</td>
                        <td>{{ "%.1f"|format(stat.winRate) }}%</td>
                        <td class="{% if stat.profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                            {{ "%+.2f"|format(stat.profit) }} units
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Bet History -->
    <div class="card" style="margin-top: 30px;">
        <h2>{{ user.username }}'s Bets</h2>
        {% if bets %}
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Game</th>
                        <th>Bet</th>
                        <th>Odds</th>
                        <th>Units</th>
                        <th>Status</th>
                        <th>Profit/Loss</th>
                        {% if is_own_profile %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for bet in bets %}
                    <tr>
                        <td>
                            {{ bet.game.away_team }} @ {{ bet.game.home_team }}
                            {% if bet.game.is_completed %}
                                <br><small class="text-muted">{{ bet.game.away_score }} - {{ bet.game.home_score }}</small>
                            {% endif %}
                        </td>
                        <td>
                            <strong>
                            {% if bet.bet_type == 'ML' %}
                                {{ bet.team }} ML
                            {% elif bet.bet_type == 'SPREAD' %}
                                {{ bet.team }} {{ bet.line|format_odds }}
                            {% elif bet.bet_type == 'TOTAL_OVER' %}
                                Over {{ bet.line }}
                            {% elif bet.bet_type == 'TOTAL_UNDER' %}
                                Under {{ bet.line }}
                            {% endif %}
                            </strong>
                        </td>
                        <td>{{ bet.odds|format_odds }}</td>
                        <td>{{ "%.2f"|format(bet.stake) }}</td>
                        <td>
                            {% if bet.result == 'WON' %}
                                <span class="badge badge-success">WON</span>
                            {% elif bet.result == 'LOST' %}
                                <span class="badge badge-danger">LOST</span>
                            {% elif bet.result == 'PUSH' %}
                                <span class="badge badge-secondary">PUSH</span>
                            {% else %}
                                <span class="badge badge-warning">PENDING</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if bet.profit is not none %}
                                <span class="{% if bet.profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                    {{ "%+.2f"|format(bet.profit) }} units
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        {% if is_own_profile %}
                        <td>
                            {% if bet.result == 'PENDING' %}
                                <button class="btn btn-sm btn-primary" onclick="editBet('{{ bet.id }}', {{ bet.odds }}, {{ bet.line or 'null' }}, {{ bet.stake }}, '{{ bet.team or '' }}')">Edit</button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteBet('{{ bet.id }}')">Delete</button>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="pagination">
            {% if pagination.has_prev %}
                <a href="{{ url_for('user_profile', username=user.username, page=pagination.prev_num) }}">&laquo; Previous</a>
            {% endif %}
            
            <span>Page {{ pagination.page }} of {{ pagination.pages }}</span>
            
            {% if pagination.has_next %}
                <a href="{{ url_for('user_profile', username=user.username, page=pagination.next_num) }}">Next &raquo;</a>
            {% endif %}
        </div>
        {% endif %}

        {% else %}
        <p class="text-muted">No bets placed yet.</p>
        {% endif %}
    </div>
</div>

{% if is_own_profile %}
<!-- Edit Bet Modal (only for own profile) -->
<div id="editBetModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Edit Bet</h2>
        <form id="editBetForm">
            <input type="hidden" id="editBetId">
            <div class="form-group">
                <label>Odds (American format)</label>
                <input type="number" id="editOdds" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Line/Spread (if applicable)</label>
                <input type="number" id="editLine" class="form-control" step="0.5">
            </div>
            <div class="form-group">
                <label>Units</label>
                <input type="number" id="editStake" class="form-control" step="0.1" required>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        </form>
    </div>
</div>

<script>
function editBet(betId, odds, line, stake, team) {
    document.getElementById('editBetId').value = betId;
    document.getElementById('editOdds').value = odds;
    document.getElementById('editLine').value = line || '';
    document.getElementById('editStake').value = stake;
    document.getElementById('editBetModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editBetModal').style.display = 'none';
}

document.getElementById('editBetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const betId = document.getElementById('editBetId').value;
    const odds = parseInt(document.getElementById('editOdds').value);
    const line = document.getElementById('editLine').value;
    const stake = parseFloat(document.getElementById('editStake').value);
    
    try {
        const response = await fetch(`/api/edit-bet/${betId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                odds: odds,
                line: line ? parseFloat(line) : null,
                stake: stake
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Bet updated successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error updating bet: ' + error.message);
    }
});

async function deleteBet(betId) {
    if (!confirm('Are you sure you want to delete this bet? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/delete-bet/${betId}`, {
            method: 'DELETE',
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('Bet deleted successfully!');
            window.location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Error deleting bet: ' + error.message);
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('editBetModal');
    if (event.target == modal) {
        closeEditModal();
    }
}
</script>

<style>
.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 30px;
    border: 1px solid #888;
    border-radius: 8px;
    width: 90%;
    max-width: 500px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: #000;
}

.btn-sm {
    padding: 4px 8px;
    font-size: 12px;
    margin-right: 4px;
}

.btn-primary {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-primary:hover {
    background-color: #0056b3;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-left: 8px;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
    border: none;
    padding: 4px 8px;
    border-radius: 4px;
    cursor: pointer;
}

.btn-danger:hover {
    background-color: #c82333;
}
</style>
{% endif %}

<style>
.pagination {
    text-align: center;
    margin-top: 20px;
    padding: 20px;
}

.pagination a {
    padding: 8px 16px;
    background-color: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    margin: 0 10px;
}

.pagination a:hover {
    background-color: #0056b3;
}

.pagination span {
    margin: 0 20px;
}
</style>

{% endblock %}

